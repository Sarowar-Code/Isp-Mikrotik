# MongoDB + Mongoose to MySQL + Prisma Migration Guide

This document provides a step-by-step guide to migrate your backend from MongoDB with Mongoose to MySQL with Prisma ORM.

---

## 1. Overview of the Migration

The goal of this migration is to replace MongoDB and Mongoose with MySQL and Prisma ORM. Prisma provides a type-safe and modern way to interact with relational databases, making it a great choice for this transition.

### Key Benefits of Prisma:
- Type-safe queries with auto-completion.
- Built-in migrations for schema management.
- Easier integration with relational databases like MySQL.

---

## 2. Major Changes Needed

### 2.1 Models
- Convert Mongoose schemas to Prisma models.
- Define relationships explicitly (e.g., `one-to-many`, `many-to-many`).

### 2.2 Controllers
- Replace Mongoose queries with Prisma queries.
- Update logic for relational data handling.

### 2.3 Queries
- Replace `populate()` with Prisma's `include` or `select`.
- Replace MongoDB's aggregation pipelines with Prisma's query capabilities.

### 2.4 DB Connection
- Replace the MongoDB connection logic with Prisma's database client.

---

## 3. New Folder Structure for Prisma

Here's the recommended folder structure after integrating Prisma:

```
src/
 ├── controllers/
 ├── models/                # Remove this folder (replaced by Prisma schema)
 ├── prisma/                # New folder for Prisma
 │    ├── migrations/       # Auto-generated by Prisma
 │    └── schema.prisma     # Prisma schema file
 ├── services/
 ├── utils/
 ├── db/
 │    └── prismaClient.js   # Prisma client instance
 ├── config/
 ├── routes/
 ├── app.js
 ├── constants.js
 └── index.js
```

---

## 4. How to Convert Mongoose Models to Prisma Models

### Example: `payment.model.js` (Mongoose) to Prisma

#### Mongoose Model:
```javascript
// filepath: backend/src/models/payment.model.js
const paymentSchema = new Schema({
  payerId: { type: Schema.Types.ObjectId, refPath: "payerModel", required: true },
  payerModel: { type: String, enum: ["Admin", "Reseller"], required: true },
  receiverId: { type: Schema.Types.ObjectId, refPath: "receiverModel", required: true },
  receiverModel: { type: String, enum: ["Admin", "SuperAdmin"], required: true },
  amount: { type: Number, required: true },
  status: { type: String, enum: ["pending", "confirmed", "rejected", "due"], default: "pending" },
  // Other fields...
});
```

#### Prisma Model:
```prisma
// filepath: src/prisma/schema.prisma
model Payment {
  id             Int      @id @default(autoincrement())
  payerId        Int
  payerModel     String   // Use enums in Prisma
  receiverId     Int
  receiverModel  String
  amount         Float
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
```

---

## 5. How to Convert Mongo Queries to Prisma Queries

### Example: Find All Payments by `payerId`

#### Mongoose Query:
```javascript
const payments = await Payment.find({ payerId }).populate("payerId");
```

#### Prisma Query:
```javascript
const payments = await prisma.payment.findMany({
  where: { payerId },
  include: { payer: true }, // Replace `populate` with `include`
});
```

---

## 6. How to Replace `populate()`, `ObjectId`, Aggregation, Arrays, References

### 6.1 Replace `populate()`
- Use Prisma's `include` or `select` for eager loading.

### 6.2 Replace `ObjectId`
- Use `Int` or `UUID` for primary keys in Prisma.

### 6.3 Replace Aggregation
- Use Prisma's `groupBy` and `aggregate` methods.

### 6.4 Replace Arrays
- Use `one-to-many` or `many-to-many` relationships in Prisma.

### 6.5 Replace References
- Use Prisma's `relation` fields to define relationships.

---

## 7. Environment Variables and Prisma Migrate Commands

### Environment Variables
Update your `.env` file with the MySQL connection string:
```
DATABASE_URL="mysql://user:password@localhost:3306/database_name"
```

### Prisma Migrate Commands
1. Initialize Prisma:
   ```bash
   npx prisma init
   ```
2. Generate Prisma Client:
   ```bash
   npx prisma generate
   ```
3. Create a Migration:
   ```bash
   npx prisma migrate dev --name init
   ```

---

## 8. Testing Checklist

- [ ] Verify database connection with Prisma.
- [ ] Test all CRUD operations for each model.
- [ ] Test relationships (e.g., `one-to-many`, `many-to-many`).
- [ ] Test API endpoints for correct data handling.
- [ ] Test error handling for invalid queries.

---

## 9. Final Recommended Backend Folder Structure

Here's the final folder structure after migration:

```
src/
 ├── controllers/           # API controllers
 ├── prisma/                # Prisma schema and migrations
 │    ├── migrations/
 │    └── schema.prisma
 ├── services/              # Business logic
 ├── utils/                 # Utility functions
 ├── db/
 │    └── prismaClient.js   # Prisma client instance
 ├── config/                # Configuration files
 ├── routes/                # API routes
 ├── app.js                 # Express app
 ├── constants.js           # Constants
 └── index.js               # Entry point
```

---

This guide provides a clear roadmap for migrating your backend to Prisma. Let me know if you need further assistance!
